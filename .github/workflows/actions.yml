name: CI

on:
  push:
    branches:
      - master
      - stable
  pull_request:
    branches:
      - master
      - stable

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'
          cache: 'gradle'
      
      - name: Install Python 3 and virtualenv
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-venv
      
      - name: Verify Python 3
        run: python3 --version
      
      - name: Create and activate virtualenv
        run: |
          python3 -m venv my_py3
          source my_py3/bin/activate
      
      - name: Install Python dependencies
        run: |
          python -m pip install --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org docutils Pygments
      
      - name: Verify Python dependencies
        run: python -m pip freeze
      
      - name: Make gradlew executable
        run: chmod +x gradlew
      
      - name: Build documentation
        run: ./gradlew -Drst2html=`which rst2html.py` usrdoc build
      
      - name: Upload documentation artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: build/docs/
          retention-days: 7
      
      - name: Upload artifacts
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        env:
          repos_pwd: ${{ secrets.REPOS_PASSWORD }}
        run: ./gradlew -Drepos_pwd=${{ secrets.REPOS_PASSWORD }} -Drepos_usr=jql_jars-INTE uploadArchives
      
      - name: Upload release artifacts
        if: github.ref == 'refs/heads/stable' && github.event_name == 'push'
        env:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repos_pwd: ${{ secrets.REPOS_PASSWORD }}
          downloads_pwd: ${{ secrets.DOWNLOADS_PASSWORD }}
          docs_pwd: ${{ secrets.DOCS_PASSWORD }}
        run: ./gradlew -Drst2html=`which rst2html.py` -Dgithub_token=${{ secrets.GITHUB_TOKEN }} -Drepos_pwd=${{ secrets.REPOS_PASSWORD }} -Drepos_usr=jql_jars-INTE '-Drelease=' -Ddownloads_pwd=${{ secrets.DOWNLOADS_PASSWORD }} -Ddownloads_usr=jql_downloads -Ddocs_pwd=${{ secrets.DOCS_PASSWORD }} -Ddocs_usr=jql_docs uploadArchives uploadBin uploadDoc